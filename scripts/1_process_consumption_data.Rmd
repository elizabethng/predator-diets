---
title: "Process consumption data for catch standardization"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Plan
[probably easiest to have a list of data frames with each entry being a separate species]

1. Create a data frame where each row is a sampled predator. Include predator specific information (weight, species), tow specific information (towid, season, location, depth, year). This approach doesn't account for the correlation of predators within tows.[Should be similar to what I did for EDA.]
2. Create a data frame where each row is a unique tow. For the average tow level consumption, have a column for average consumption. Include average predator length and sample size. 
3. [separate script] In TMB, write up a simple hurdle model (or Tweedie model??) for a fixed-effects catch standardization. 


Later: I can incorporate other tow covariates, like amount of prey or predator in tow
4. Include stomach volume or mass for total

# Preliminaries
```{r packages and options}
library(tidyverse)
library(here)

save_data = FALSE
use_harengus = FALSE # use only C. harengus? otherwise all clupea spp.
```

```{r load diet data}
frdata = read_csv(here("data", "fr_diet.csv"), guess_max = 365080) %>%
  dplyr::select(-X1)
```

# 0. Clean data
Make longitude negative, remove 7 observations missing date and location data, and one spatial outlier
```{r}
frdata = frdata %>% mutate(declon  = - declon) %>%
  filter(!is.na(month)) %>%
  filter(declon > -78)
```


Unique tow ID is cruise6 + station
Unique predator ID needs to account for cruise, station, species, replicate, and sex
```{r create unique IDs}
frdata = frdata %>% mutate(
  towid = paste(cruise6, station),
  predid = paste(cruise6, station, svspp, pdid, pdsex)
)
```


# 1. Create a data frame where each row is a sampled predator
Get the ids and predator data, match it up with consumption

## Prey Data
I will not use eggs, larvae, or scales, but like Jon, I will use the Clupidae category, sice I guess these are the most common clupeidae. All prey weights are real numbers. 
```{r check herring weights}
filter(frdata, analcat == "CLUFAM") %>%
  group_by(pynam) %>%
  summarize(mean = mean(pyamtw),
            sd = sd(pyamtw),
            n = n())

slice(frdata, frdata$pynam %>% str_which("CLUP")) %>%
  group_by(pynam) %>%
  summarize(mean = mean(pyamtw),
            sd = sd(pyamtw),
            n = n())
```

```{r filter out prey}
if(use_harengus == FALSE){
  preydat = frdata %>% 
    filter(pynam == "CLUPEA HARENGUS" | pynam == "CLUPEIDAE") %>%
    dplyr::select(predid, pyamtw)
}else{
  preydat = frdata %>% 
    filter(pynam == "CLUPEA HARENGUS") %>%
    dplyr::select(predid, pyamtw)
}
```

Check that there is just one entry per predator, and also look at the weights. Note there is one entry with a zero weight, but that won't matter once I merge with the predator data anyway.
```{r check prey data}
sum(duplicated(preydat$predid)) > 0 # any duplicates?

summary(preydat$pyamtw) # any zero weights?
sum(preydat$pyamtw == 0)
```

## Predator Data
Create a data frame with one row per predator and all the relevant predator/tow info.
```{r simplify predator data}
preddat = frdata %>%
  filter(pynam != "EMPTY") %>% # remove empty stomachs, from 289,470 to 162,203
  dplyr::select(towid, station, geoarea, declat, declon, month, day, year, season, setdepth,
         predid, pdcomnam, pdsex, pdlen, sizecat, pdwgt) %>%
  distinct()

sum(duplicated(preddat$predid)) > 0 # any duplicates?
```

## Merge predators and prey
Now merge with a dataframe with the rest of the predator data. It should have the same number of rows as predid unless I have wonky duplicated stuff that needs more investigation. Need to convert NAs to 0s for unobserved prey. 
```{r merge predator and consumption data}
dat_preds_all = left_join(preddat, preydat, by = "predid") %>%
  mutate(pyamtw = ifelse(is.na(pyamtw), 0, pyamtw),
         pypres = ifelse(pyamtw == 0, 0, 1))
#dat_preds_all$pyamtw = ifelse(is.na(dat_preds_all$pyamtw), 0, dat_preds_all$pyamtw)

if(save_data == TRUE) saveRDS(dat_preds_all, here("output", "data_formatted", "dat_preds_all.rds"))
```

Split data by species.[Actually probably don't need to do this.]
```{r}
pred_species = unique(dat_preds_all$pdcomnam)

dat_preds = vector("list", length(pred_species))
names(dat_preds) = pred_species

for(i in seq(pred_species)){
  dat_preds[[i]] = filter(dat_preds_all, pdcomnam == pred_species[i])
}
```


# 2. Create a data frame where each row is a unique tow. 
Need to take the data frame I have now and condense by tow/species combo
```{r pool predators in tows}
pooled_tows = dat_preds %>% lapply(. %>% 
  group_by(towid) %>%
  summarize(mean_pyamtw = mean(pyamtw), 
            mean_pdlen = mean(pdlen),
            pypres = max(pypres),
            n_preds = n())
  )
```

```{r check data pool}
for(i in seq(pred_species)){
  print(nrow(dat_preds[[i]]) == sum(pooled_tows[[i]]$n_preds)) # accounting for same number of samples?
}
```

```{r get one tow per row}
towdat = frdata %>% 
  dplyr::select(towid, station, geoarea, declat, declon, month, day, year, season, setdepth) %>%
  distinct()

sum(duplicated(preddat$predid)) > 0 # any duplicates?
```

Like before, need to set weight for tows without prey consumption to 0. Going to leave mean_pdlen as NA for now, I can always change it later if I run into problems. 
```{r combine tows and pooled data}
dat_tows = pooled_tows %>% lapply(. %>%
  left_join(towdat, ., by = "towid") %>%
    mutate(mean_pyamtw = ifelse(is.na(mean_pyamtw), 0, mean_pyamtw),
           pypres = ifelse(mean_pyamtw == 0, 0, 1),
           n_preds = ifelse(is.na(n_preds), 0, n_preds))
  )
```


```{r compare sizes}
sapply(dat_preds, nrow)
sapply(dat_tows, nrow)
sapply(dat_preds, nrow) == sapply(dat_tows, function(x) sum(x$n_preds)) # underlying predator numbers
```


# 3. Save output
```{r save output}
if(save_data == TRUE){
  saveRDS(dat_preds, file = "../output/data_formatted/dat_preds.rds")
  saveRDS(dat_tows, file = "../output/data_formatted/dat_tows.rds")
}
```


dat_preds has one row for each predator (it does not include tows where predators did not occur)
dat_tows has one row for each tow. predator info is averaged accross predators of the same species within the same tow and it contains information about tows that did not have any predators in it (i.e., rows where n_preds == 0)










